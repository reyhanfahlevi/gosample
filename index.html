<!DOCTYPE html>
<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
        <h1>USER</h1>
        <form id="formsearch" method="GET">
            <div class="col-md-3 col-xs-3">
                <div class="input-group">
                    <span class="input-group-addon" id="basic-addon2">Limit</span>
                    <select name="limit" class="form-control">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3 col-xs-3">
                <div class="input-group">
                    <span class="input-group-addon" id="basic-addon2">Offset</span>
                    <input type="text" name="offset" class="form-control numberOnly ">
                </div>
            </div>
            <div class="col-md-6  col-xs-6">
                <div class="input-group">
                    <input name="search" type="text" class="form-control" aria-label="...">
                    <div class="input-group-btn">
                        <button id="btn-search" class="btn btn-info">Search</button>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <div class="col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
        <table id="datalist" class="table table-responsive">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="col-md-10 col-md-offset-1 col-xs-10 col-xs-offset-1">
        <h1 id="counter">-</h1>
    </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        Reload("#datalist", "http://localhost:9002/api/users")
        $("#formsearch").on("submit", function(e) {
            e.preventDefault()
            var params = $(this).serialize()
            var url = "http://localhost:9002/api/users?" + params;
            Reload("#datalist", url);

        });

        $("#btn-search").on("click", function(e) {
            e.preventDefault();
            $("#formsearch").submit();
        })

        $(".numberOnly").keydown(function (e) {
            // Allow: backspace, delete, tab, escape, enter and .
            if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    // Allow: Ctrl+A, Command+A
                    (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                    // Allow: home, end, left, right, down, up
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                // let it happen, don't do anything
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });

        setTimeout(function() {
            ping(1)
        }, 100)
    });

    function ping(c) {
        if (typeof(c) == undefined) {
            c = 0;
        }
        $.ajax({
            url: "http://localhost:9002/pingcounter?handler=users&c=" + c,
            method: "GET",
            dataType: "json",
            success:function(data) {
                console.log(data)
                if (typeof(data.data) !== undefined) {
                    $("h1#counter").html("Visitor Counter: " + data.data.counter);
                }
            }
        });

    }

    function Reload(tableid, url) {
        $.ajax({
            url: url.toLowerCase(),
            dataType: "json",
            method: "GET",
            crossDomain: true,
            success: function(data) {
                if(data.total_data == 0) {
                    alert("No Data Found")
                    return
                }
                if(typeof(data.data) !== undefined) {
                    var key = Object.keys(data.data[0])
                    $(tableid).find("thead").html("");
                    $(tableid).find("tbody").html("");

                    var thead = "<tr>"

                    $.each(key, function(k,v) {
                        thead += "<th>" + (v.replace("_", " ")).toLocaleUpperCase() + "</th>";
                    });
                    thead += "</tr>";

                    $(tableid).find("thead").append(thead)

                    var tbody = ""
                    $.each(data.data, function(k,v) {
                        tbody = "<tr>"
                        tbody += "<td>" + v.user_id + "</td>";
                        tbody += "<td>" + v.full_name + "</td>";
                        tbody += "<td>" + v.email+ "</td>";
                        tbody += "<td>" + v.birth_date + "</td>";
                        tbody += "<td>" + v.create_time + "</td>";
                        tbody += "<td>" + v.update_time + "</td>";
                        tbody += "<td>" + v.msisdn + "</td>";
                        tbody += "<td>" + v.age + "</td>";
                        tbody += "</tr>"
                        $(tableid).find("tbody").append(tbody)
                    });
                }
            }
        })
    }

</script>

</body>
</html>